/*! BattleOfArtillery 2014-06-30 */

ENUM={SHAPE_PLATE:{ROUND:1,RECT:2},GAME_STATE:{INIT:0,START:1,PAUSE:2,LEVEL_UP:3,PLAY:4,OVER:5},BULLET:{IRON_1:0,IRON_2:1,IRON_3:2,LAZER:3}},Util=function(){return{calDistance:function(a,b,c,d){return Math.sqrt((a-c)*(a-c)+(b-d)*(b-d))}}}(),Plate=function(a,b){this.shape=a,this.x=0,this.y=0,this.dx=0,this.dy=0,this.angle=Math.PI/2,this.size=b,this.state=0,this.speed=0,this.fillStyle="#0000FF",this.strokeBodyStyle="#0000FF",this.strokeHitedBodyStyle="#DF0101",this.strokeGunStyle="white",this.edgeWidth=b/2,this.blood=100,this.isDied=!1,this.isHit=!1,this.bullets=WeaponFactory.makeBullets(ENUM.BULLET.LAZER,1e5)},Plate.prototype.setPosition=function(a,b){this.x=a,this.y=b},Plate.prototype.hit=function(){this.isHit=!0,this.blood-=5,this.blood<=0&&(this.isDied=!0)},Plate.prototype.update=function(){this.x+=this.dx,this.y+=this.dy,this.isHit=this.isHit&&!this.isHit},Plate.prototype.render=function(a){this.isHit?this.renderHitedPlate(a):(this.renderBody(a),this.renderGun(a))},Plate.prototype.renderHitedPlate=function(a){this.renderBody(a),this.renderGun(a)},Plate.prototype.renderGun=function(a){a.save(),a.beginPath(),a.translate(this.x,this.y),a.rotate(this.angle),a.moveTo(0,0),a.lineTo(25,0),a.closePath(),a.strokeStyle=this.strokeGunStyle,a.lineWidth=5,a.stroke(),a.restore()},Plate.prototype.renderBody=function(a){switch(a.save(),a.translate(this.x,this.y),a.beginPath(),this.shape){case ENUM.SHAPE_PLATE.ROUND:a.arc(0,0,this.size,0,2*Math.PI,!1);break;case ENUM.SHAPE_PLATE.RECT:a.rect(0-this.size,0-this.size,2*this.size,2*this.size)}a.lineWidth=this.edgeWidth,a.strokeStyle=this.isHit?this.strokeHitedBodyStyle:this.strokeBodyStyle,a.stroke(),a.closePath(),a.restore()},Bullet=function(a){this.strength=1,this.type=a,this.initX=0,this.initY=0,this.x=0,this.y=0,this.dx=10,this.dy=0,this.angle=0,this.isFired=!1,this.isExploded=!1},Bullet.prototype.update=function(a,b,c){this.isFired?(this.x+=this.dx,this.y+=this.dy):(this.initX=a,this.initY=b,this.angle=c,this.isFired=!0)},Bullet.prototype.calAbsPosition=function(){var a={x:this.initX+this.x*Math.cos(this.angle),y:this.initY+this.x*Math.sin(this.angle)};return a},Bullet.prototype.render=function(a){this.isFired&&!this.isExploded&&(a.save(),a.translate(this.initX,this.initY),a.rotate(this.angle),a.translate(this.x+50,this.y),a.beginPath(),a.moveTo(0,1),a.lineTo(10,1),a.lineTo(10,-1),a.lineTo(0,-1),a.closePath(),a.fillStyle="#DF0101",a.shadowBlur=5,a.shadowColor="#DF0101",a.fill(),a.restore())},Gunner=function(a,b,c,d){this.bullets=[],this.x=a,this.y=b,this.angle=-Math.PI/2,this.fire=!1,this.gunX=c,this.gunY=d,this.fillStyle="rgba(255,0,0, 0.5)",this.strokeStyle="rgb(255,0,0)",this.sightStyle="#FFFFFF",this.edgeWidth=1,this.sightSize=30,this.numOfFiredBullets=0},Gunner.prototype.addBullets=function(a,b){var c=WeaponFactory.makeBullets(a,b),d=this.bullets;c.forEach(function(a){d.push(a)})},Gunner.prototype.start=function(){this.addBullets(ENUM.BULLET.IRON_1,1e3)},Gunner.prototype.update=function(a){this.x=a.mouseX,this.y=a.mouseY,this.fire=a.mouseDown,this.moveLeft=a.leftKey,this.moveRight=a.rightKey,this.moveLeft&&(this.gunX+=-10),this.moveRight&&(this.gunX+=10),this.angle=this.calAngleToTarget(this.gunX,this.gunY,this.x,this.y),this.fire&&this.numOfFiredBullets<this.bullets.length&&(this.bullets[this.numOfFiredBullets].update(this.gunX,this.gunY,this.angle),this.numOfFiredBullets+=1);for(var b=0;b<this.numOfFiredBullets;b++){var c=this.bullets[b];c.update()}},Gunner.prototype.shoot=function(a){var b=a.weapons,c=0;return b.forEach(function(a){c+=this.shootWeapon(a)},this),a.removeDiedWeapons(),c},Gunner.prototype.shootWeapon=function(a){var b=0;if(a.shape===ENUM.SHAPE_PLATE.ROUND)for(var c=0;c<this.numOfFiredBullets;c++){var d=this.bullets[c];if(!d.isExploded){var e=d.calAbsPosition();if(!(e.x<0)){var f=Util.calDistance(e.x,e.y,a.x,a.y);f<this.sightSize&&(a.hit(),d.isExploded=!0,b++)}}}return b},Gunner.prototype.renderSight=function(a){a.save(),a.translate(this.x,this.y),a.beginPath(),a.arc(0,0,this.sightSize,0,2*Math.PI),a.fillStyle=this.fillStyle,a.fill(),a.lineWidth=this.edgeWidth,a.strokeStyle=this.strokeStyle,a.stroke(),a.closePath(),a.restore()},Gunner.prototype.renderTarget=function(a){a.save(),a.translate(this.x,this.y),a.beginPath(),a.moveTo(0,0-this.sightSize),a.lineTo(0,this.sightSize),a.moveTo(0-this.sightSize,0),a.lineTo(this.sightSize,0),a.closePath(),a.strokeStyle=this.sightStyle,a.stroke(),a.restore()},Gunner.prototype.calAngleToTarget=function(a,b,c,d){var e=(d-b)/(c-a),f=Math.atan(e);return b>d&&a>c&&(f=Math.PI+f),f},Gunner.prototype.renderBody=function(a){a.save(),a.translate(this.gunX,this.gunY),a.rotate(this.angle),a.beginPath(),a.moveTo(0,0),a.lineTo(20,0),a.strokeStyle="#FFFFFF",a.lineWidth=this.sightSize/2,a.lineCap="round",a.stroke(),a.moveTo(20,0),a.lineTo(50,0),a.strokeStyle="#FFFFFF",a.lineWidth=this.sightSize/4,a.lineCap="round",a.stroke(),a.closePath(),a.restore()},Gunner.prototype.renderBase=function(a){a.save(),a.translate(this.gunX,this.gunY),a.beginPath(),a.arc(0,0,this.sightSize,0,Math.PI,!0),a.fillStyle=this.fillStyle,a.fill(),a.strokeStyle=this.strokeStyle,a.lineWidth=this.sightSize/2,a.stroke(),a.closePath(),a.restore()},Gunner.prototype.renderGun=function(a){this.renderBase(a),this.renderBody(a)},Gunner.prototype.renderBullets=function(a){this.bullets.forEach(function(b){b.render(a)})},Gunner.prototype.render=function(a){this.renderGun(a),this.renderSight(a),this.renderTarget(a),this.renderBullets(a)},WeaponFactory={},WeaponFactory.makePlate=function(a,b){return new Plate(a,b)},WeaponFactory.makePlates=function(a,b,c){for(var d=[],e=0;a>e;e++)d.push(this.makePlate(b,c));return d},WeaponFactory.makeBullet=function(a){return new Bullet(a)},WeaponFactory.makeBullets=function(a,b){for(var c=[],d=0;b>d;d++)c.push(this.makeBullet(a));return c},Player=function(a,b){this.name=a,this.role=b,this.weapons=[]},Player.prototype.start=function(){var a=WeaponFactory.makePlates(10,ENUM.SHAPE_PLATE.ROUND,15);this.addWeapon(a),this.weapons.forEach(function(a,b){a.setPosition(100*b,10)})},Player.prototype.addWeapon=function(a){var b=this.weapons;a.forEach(function(a){b.push(a)})},Player.prototype.connect=function(){},Player.prototype.update=function(){this.weapons.forEach(function(a){a.update()},this)},Player.prototype.render=function(a){this.weapons.forEach(function(b){b.render(a)})},Player.prototype.removeDiedWeapons=function(){for(var a=this.weapons,b=a.length-1;b>=0;b--){var c=a[b];c.isDied&&a.splice(b,1)}},Game=function(){this.players=[],this.gunners=[],this.ctx=null,this.theCanvas=null,this.currentGameState=ENUM.GAME_STATE.INIT,this.keyPressList={},this.isMouseDown=!1,this.background={width:800,height:600,color:"#000000"},this.mouseX=this.background.width/2,this.mouseY=this.background.height/2,this.laserSound=null},Game.prototype.loadSound=function(){var a;a=document.createElement("audio"),document.body.appendChild(a),a.setAttribute("src","sound/laser.mp3"),this.laserSound=a},Game.prototype.addPlayer=function(a){var b=new Player(a);return this.players.push(b),b},Game.prototype.addGunner=function(){var a=new Gunner(this.background.width/2,this.background.height/2,this.background.width/2,this.background.height);return this.gunners.push(a),a},Game.prototype.drawBackground=function(){this.ctx.fillStyle=this.background.color,this.ctx.fillRect(0,0,this.background.width,this.background.height),this.drawBorder()},Game.prototype.drawBorder=function(){this.ctx.strokeStyle="#FF0000",this.ctx.strokeRect(1,1,this.background.width-1,this.background.height-1)},Game.prototype.getContext=function(){this.theCanvas=document.getElementById("game"),this.ctx=this.theCanvas.getContext("2d"),this.ctx.height=this.theCanvas.height,this.ctx.width=this.theCanvas.width},Game.prototype.registerKey=function(){var a=this;document.onkeydown=function(b){b=b?b:window.event,a.keyPressList[b.keyCode]=!0},document.onkeyup=function(b){b=b?b:window.event,a.keyPressList[b.keyCode]=!1}},Game.prototype.registerMouse=function(){document.addEventListener("mousemove",this.updateMousePosition.bind(this),!1),document.addEventListener("mousedown",this.updateMouseDownClick.bind(this),!1),document.addEventListener("mouseup",this.updateMouseUpClick.bind(this),!1)},Game.prototype.updateMouseUpClick=function(){this.isMouseDown=!1},Game.prototype.updateMouseDownClick=function(){this.isMouseDown=!0},Game.prototype.updateMousePosition=function(a){var b=this.theCanvas.getBoundingClientRect();this.mouseX=a.clientX-b.left,this.mouseY=a.clientY-b.top,this.mouseY>this.background.height&&(this.mouseY=this.background.height),this.mouseX>this.background.width&&(this.mouseX=this.background.width)},Game.prototype.start=function(){this.loadSound(),this.getContext(),this.registerKey(),this.registerMouse();var a=this.addPlayer("player1"),b=this.addGunner("gunner1");a.start(),b.start(),this.switchGameState(ENUM.GAME_STATE.INIT)},Game.prototype.update=function(){this.players.forEach(function(a){a.update()}),this.gunners.forEach(function(a){var b={mouseX:this.mouseX,mouseY:this.mouseY,mouseDown:this.isMouseDown||this.keyPressList[13],leftKey:this.keyPressList[37]||this.keyPressList[65],rightKey:this.keyPressList[39]||this.keyPressList[68]};a.update(b),b.mouseDown&&this.laserSound.play()},this),this.currentGameState===ENUM.GAME_STATE.PLAY&&this.checkCollision()},Game.prototype.render=function(){var a=this.ctx;this.players.forEach(function(b){b.render(a)}),this.gunners.forEach(function(b){b.render(a)})},Game.prototype.checkCollision=function(){this.gunners.forEach(function(a){this.players.forEach(function(b){a.shoot(b)},this)},this)},Game.prototype.switchGameState=function(a){switch(this.currentGameState=a,this.currentGameState){case ENUM.GAME_STATE.INIT:this.currentGameStateFunction=this.initGame;break;case ENUM.GAME_STATE.LEVEL_UP:this.currentGameStateFunction=this.levelUp;break;case ENUM.GAME_STATE.PLAY:this.currentGameStateFunction=this.play}},Game.prototype.levelUp=function(){this.players.forEach(function(a){a.weapons.forEach(function(){})}),this.switchGameState(ENUM.GAME_STATE.PLAY)},Game.prototype.drawTitle=function(){var a=this.ctx;a.save(),a.font="20px Georgia",a.fillStyle="white",a.fillText("Press space to start game!",this.background.height/2,this.background.width/2),a.restore()},Game.prototype.initGame=function(){this.drawBackground(),this.render(),this.drawTitle(),this.checkKeys()},Game.prototype.checkKeys=function(){this.currentGameState===ENUM.GAME_STATE.INIT&&this.keyPressList[32]&&this.switchGameState(ENUM.GAME_STATE.LEVEL_UP)},Game.prototype.play=function(){this.drawBackground(),this.update(),this.render(),this.checkKeys()},Game.prototype.run=function(){this.currentGameStateFunction(),window.requestAnimationFrame(this.run.bind(this))},window.addEventListener("load",function(){var a=new Game;a.start(),a.run()},!1);
//# sourceMappingURL=sourcemap.map