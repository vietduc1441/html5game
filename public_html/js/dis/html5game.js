/*! BattleOfArtillery 2014-07-03 */

ENUM={SHAPE_PLATE:{ROUND:1,RECT:2},GAME_STATE:{INIT:0,START:1,PAUSE:2,LEVEL_UP:3,PLAY:4,OVER:5},BULLET:{IRON_1:0,IRON_2:1,IRON_3:2,LAZER:3}},Util=function(){return{calDistance:function(x1,y1,x2,y2){return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))}}}(),Plate=function(shape,size){this.shape=shape,this.x=0,this.y=0,this.dx=0,this.dy=0,this.angle=Math.PI/2,this.size=size,this.state=0,this.speed=0,this.fillStyle="#0000FF",this.strokeBodyStyle="#0000FF",this.strokeHitedBodyStyle="#DF0101",this.strokeGunStyle="white",this.edgeWidth=size/2,this.blood=100,this.isDied=!1,this.isHit=!1,this.bullets=WeaponFactory.makeBullets(ENUM.BULLET.LAZER,1e5)},Plate.prototype.setPosition=function(x,y){this.x=x,this.y=y},Plate.prototype.hit=function(){this.isHit=!0,this.blood-=5,this.blood<=0&&(this.isDied=!0)},Plate.prototype.update=function(){this.x+=this.dx,this.y+=this.dy,this.isHit=this.isHit&&!this.isHit},Plate.prototype.render=function(ctx){this.isHit?this.renderHitedPlate(ctx):(this.renderBody(ctx),this.renderGun(ctx))},Plate.prototype.renderHitedPlate=function(ctx){this.renderBody(ctx),this.renderGun(ctx)},Plate.prototype.renderGun=function(ctx){ctx.save(),ctx.beginPath(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.moveTo(0,0),ctx.lineTo(25,0),ctx.closePath(),ctx.strokeStyle=this.strokeGunStyle,ctx.lineWidth=5,ctx.stroke(),ctx.restore()},Plate.prototype.renderBody=function(ctx){switch(ctx.save(),ctx.translate(this.x,this.y),ctx.beginPath(),this.shape){case ENUM.SHAPE_PLATE.ROUND:ctx.arc(0,0,this.size,0,2*Math.PI,!1);break;case ENUM.SHAPE_PLATE.RECT:ctx.rect(0-this.size,0-this.size,2*this.size,2*this.size)}ctx.lineWidth=this.edgeWidth,ctx.strokeStyle=this.isHit?this.strokeHitedBodyStyle:this.strokeBodyStyle,ctx.stroke(),ctx.closePath(),ctx.restore()},Bullet=function(type){this.strength=1,this.type=type,this.initX=0,this.initY=0,this.x=0,this.y=0,this.dx=10,this.dy=0,this.angle=0,this.isFired=!1,this.isExploded=!1},Bullet.prototype.update=function(x,y,angle){this.isFired?(this.x+=this.dx,this.y+=this.dy):(this.initX=x,this.initY=y,this.angle=angle,this.isFired=!0)},Bullet.prototype.calAbsPosition=function(){var result={x:this.initX+this.x*Math.cos(this.angle),y:this.initY+this.x*Math.sin(this.angle)};return result},Bullet.prototype.render=function(ctx){this.isFired&&!this.isExploded&&(ctx.save(),ctx.translate(this.initX,this.initY),ctx.rotate(this.angle),ctx.translate(this.x+50,this.y),ctx.beginPath(),ctx.moveTo(0,1),ctx.lineTo(10,1),ctx.lineTo(10,-1),ctx.lineTo(0,-1),ctx.closePath(),ctx.fillStyle="#DF0101",ctx.shadowBlur=5,ctx.shadowColor="#DF0101",ctx.fill(),ctx.restore())},Gunner=function(initX,initY,gunX,gunY){this.bullets=[],this.x=initX,this.y=initY,this.angle=-Math.PI/2,this.fire=!1,this.gunX=gunX,this.gunY=gunY,this.fillStyle="rgba(255,0,0, 0.5)",this.strokeStyle="rgb(255,0,0)",this.sightStyle="#FFFFFF",this.edgeWidth=1,this.sightSize=30,this.numOfFiredBullets=0},Gunner.prototype.addBullets=function(type,number){var newbullets=WeaponFactory.makeBullets(type,number),_bullets=this.bullets;newbullets.forEach(function(bu){_bullets.push(bu)})},Gunner.prototype.start=function(){this.addBullets(ENUM.BULLET.IRON_1,1e3)},Gunner.prototype.update=function(evtInfo){this.x=evtInfo.mouseX,this.y=evtInfo.mouseY,this.fire=evtInfo.mouseDown,this.moveLeft=evtInfo.leftKey,this.moveRight=evtInfo.rightKey,this.moveLeft&&(this.gunX+=-10),this.moveRight&&(this.gunX+=10),this.angle=this.calAngleToTarget(this.gunX,this.gunY,this.x,this.y),this.fire&&this.numOfFiredBullets<this.bullets.length&&(this.bullets[this.numOfFiredBullets].update(this.gunX,this.gunY,this.angle),this.numOfFiredBullets+=1);for(var i=0;i<this.numOfFiredBullets;i++){var bullet=this.bullets[i];bullet.update()}},Gunner.prototype.shoot=function(player){var weapons=player.weapons,countHit=0;return weapons.forEach(function(weapon){countHit+=this.shootWeapon(weapon)},this),player.removeDiedWeapons(),countHit},Gunner.prototype.shootWeapon=function(weapon){var totalHit=0;if(weapon.shape===ENUM.SHAPE_PLATE.ROUND)for(var i=0;i<this.numOfFiredBullets;i++){var bullet=this.bullets[i];if(!bullet.isExploded){var absPosBullet=bullet.calAbsPosition();if(!(absPosBullet.x<0)){var distance=Util.calDistance(absPosBullet.x,absPosBullet.y,weapon.x,weapon.y);distance<this.sightSize&&(weapon.hit(),bullet.isExploded=!0,totalHit++)}}}return totalHit},Gunner.prototype.renderSight=function(ctx){ctx.save(),ctx.translate(this.x,this.y),ctx.beginPath(),ctx.arc(0,0,this.sightSize,0,2*Math.PI),ctx.fillStyle=this.fillStyle,ctx.fill(),ctx.lineWidth=this.edgeWidth,ctx.strokeStyle=this.strokeStyle,ctx.stroke(),ctx.closePath(),ctx.restore()},Gunner.prototype.renderTarget=function(ctx){ctx.save(),ctx.translate(this.x,this.y),ctx.beginPath(),ctx.moveTo(0,0-this.sightSize),ctx.lineTo(0,this.sightSize),ctx.moveTo(0-this.sightSize,0),ctx.lineTo(this.sightSize,0),ctx.closePath(),ctx.strokeStyle=this.sightStyle,ctx.stroke(),ctx.restore()},Gunner.prototype.calAngleToTarget=function(x1,y1,x2,y2){var tg=(y2-y1)/(x2-x1),angle=Math.atan(tg);return y1>y2&&x1>x2&&(angle=Math.PI+angle),angle},Gunner.prototype.renderBody=function(ctx){ctx.save(),ctx.translate(this.gunX,this.gunY),ctx.rotate(this.angle),ctx.beginPath(),ctx.moveTo(0,0),ctx.lineTo(20,0),ctx.strokeStyle="#FFFFFF",ctx.lineWidth=this.sightSize/2,ctx.lineCap="round",ctx.stroke(),ctx.moveTo(20,0),ctx.lineTo(50,0),ctx.strokeStyle="#FFFFFF",ctx.lineWidth=this.sightSize/4,ctx.lineCap="round",ctx.stroke(),ctx.closePath(),ctx.restore()},Gunner.prototype.renderBase=function(ctx){ctx.save(),ctx.translate(this.gunX,this.gunY),ctx.beginPath(),ctx.arc(0,0,this.sightSize,0,Math.PI,!0),ctx.fillStyle=this.fillStyle,ctx.fill(),ctx.strokeStyle=this.strokeStyle,ctx.lineWidth=this.sightSize/2,ctx.stroke(),ctx.closePath(),ctx.restore()},Gunner.prototype.renderGun=function(ctx){this.renderBase(ctx),this.renderBody(ctx)},Gunner.prototype.renderBullets=function(ctx){this.bullets.forEach(function(bullet){bullet.render(ctx)})},Gunner.prototype.render=function(ctx){this.renderGun(ctx),this.renderSight(ctx),this.renderTarget(ctx),this.renderBullets(ctx)},WeaponFactory={},WeaponFactory.makePlate=function(shape,size){return new Plate(shape,size)},WeaponFactory.makePlates=function(number,shape,size){for(var plates=[],i=0;number>i;i++)plates.push(this.makePlate(shape,size));return plates},WeaponFactory.makeBullet=function(type){return new Bullet(type)},WeaponFactory.makeBullets=function(type,number){for(var bullets=[],i=0;number>i;i++)bullets.push(this.makeBullet(type));return bullets},Player=function(name,role){this.name=name,this.role=role,this.weapons=[]},Player.prototype.start=function(){var plates=WeaponFactory.makePlates(10,ENUM.SHAPE_PLATE.ROUND,15);this.addWeapon(plates),this.weapons.forEach(function(plate,index){plate.setPosition(100*index,10)})},Player.prototype.addWeapon=function(weapons){var _weapons=this.weapons;weapons.forEach(function(item){_weapons.push(item)})},Player.prototype.connect=function(){},Player.prototype.update=function(){this.weapons.forEach(function(weapon){weapon.update()},this)},Player.prototype.render=function(ctx){this.weapons.forEach(function(weapon){weapon.render(ctx)})},Player.prototype.removeDiedWeapons=function(){for(var weapons=this.weapons,i=weapons.length-1;i>=0;i--){var weapon=weapons[i];weapon.isDied&&weapons.splice(i,1)}},Game=function(){this.players=[],this.gunners=[],this.ctx=null,this.theCanvas=null,this.currentGameState=ENUM.GAME_STATE.INIT,this.keyPressList={},this.isMouseDown=!1,this.background={width:800,height:600,color:"#000000"},this.mouseX=this.background.width/2,this.mouseY=this.background.height/2,this.laserSound=null},Game.prototype.loadSound=function(){var laserSound;laserSound=document.createElement("audio"),document.body.appendChild(laserSound),laserSound.setAttribute("src","sound/laser.mp3"),this.laserSound=laserSound},Game.prototype.addPlayer=function(name){var newPlayer=new Player(name);return this.players.push(newPlayer),newPlayer},Game.prototype.addGunner=function(){var newGunner=new Gunner(this.background.width/2,this.background.height/2,this.background.width/2,this.background.height);return this.gunners.push(newGunner),newGunner},Game.prototype.drawBackground=function(){this.ctx.fillStyle=this.background.color,this.ctx.fillRect(0,0,this.background.width,this.background.height),this.drawBorder()},Game.prototype.drawBorder=function(){this.ctx.strokeStyle="#FF0000",this.ctx.strokeRect(1,1,this.background.width-1,this.background.height-1)},Game.prototype.getContext=function(){this.theCanvas=document.getElementById("game"),this.ctx=this.theCanvas.getContext("2d"),this.ctx.height=this.theCanvas.height,this.ctx.width=this.theCanvas.width},Game.prototype.registerKey=function(){var self=this;document.onkeydown=function(e){e=e?e:window.event,self.keyPressList[e.keyCode]=!0},document.onkeyup=function(e){e=e?e:window.event,self.keyPressList[e.keyCode]=!1}},Game.prototype.registerMouse=function(){document.addEventListener("mousemove",this.updateMousePosition.bind(this),!1),document.addEventListener("mousedown",this.updateMouseDownClick.bind(this),!1),document.addEventListener("mouseup",this.updateMouseUpClick.bind(this),!1)},Game.prototype.updateMouseUpClick=function(){this.isMouseDown=!1},Game.prototype.updateMouseDownClick=function(){this.isMouseDown=!0},Game.prototype.updateMousePosition=function(evt){var rect=this.theCanvas.getBoundingClientRect();this.mouseX=evt.clientX-rect.left,this.mouseY=evt.clientY-rect.top,this.mouseY>this.background.height&&(this.mouseY=this.background.height),this.mouseX>this.background.width&&(this.mouseX=this.background.width)},Game.prototype.start=function(){this.loadSound(),this.getContext(),this.registerKey(),this.registerMouse();var newPlayer=this.addPlayer("player1"),newGunner=this.addGunner("gunner1");newPlayer.start(),newGunner.start(),this.switchGameState(ENUM.GAME_STATE.INIT)},Game.prototype.update=function(){this.players.forEach(function(player){player.update()}),this.gunners.forEach(function(gunner){var evtInf={mouseX:this.mouseX,mouseY:this.mouseY,mouseDown:this.isMouseDown||this.keyPressList[13],leftKey:this.keyPressList[37]||this.keyPressList[65],rightKey:this.keyPressList[39]||this.keyPressList[68]};gunner.update(evtInf),evtInf.mouseDown&&this.laserSound.play()},this),this.currentGameState===ENUM.GAME_STATE.PLAY&&this.checkCollision()},Game.prototype.render=function(){var _ctx=this.ctx;this.players.forEach(function(player){player.render(_ctx)}),this.gunners.forEach(function(gunner){gunner.render(_ctx)})},Game.prototype.checkCollision=function(){this.gunners.forEach(function(gunner){this.players.forEach(function(player){gunner.shoot(player)},this)},this)},Game.prototype.switchGameState=function(newState){switch(this.currentGameState=newState,this.currentGameState){case ENUM.GAME_STATE.INIT:this.currentGameStateFunction=this.initGame;break;case ENUM.GAME_STATE.LEVEL_UP:this.currentGameStateFunction=this.levelUp;break;case ENUM.GAME_STATE.PLAY:this.currentGameStateFunction=this.play}},Game.prototype.levelUp=function(){this.players.forEach(function(player){player.weapons.forEach(function(){})}),this.switchGameState(ENUM.GAME_STATE.PLAY)},Game.prototype.drawTitle=function(){var ctx=this.ctx;ctx.save(),ctx.font="20px Georgia",ctx.fillStyle="white",ctx.fillText("Press space to start game!",this.background.height/2,this.background.width/2),ctx.restore()},Game.prototype.initGame=function(){this.drawBackground(),this.render(),this.drawTitle(),this.checkKeys()},Game.prototype.checkKeys=function(){this.currentGameState===ENUM.GAME_STATE.INIT&&this.keyPressList[32]&&this.switchGameState(ENUM.GAME_STATE.LEVEL_UP)},Game.prototype.play=function(){this.drawBackground(),this.update(),this.render(),this.checkKeys()},Game.prototype.run=function(){this.currentGameStateFunction(),window.requestAnimationFrame(this.run.bind(this))},window.addEventListener("load",function(){var game=new Game;game.start(),game.run()},!1);
//# sourceMappingURL=sourcemap.map