define(["source/weaponFactory","source/enum","source/util"],function(e,t,n){var r=function(e,t,n,r){this.bullets=[],this.x=e,this.y=t,this.angle=-Math.PI/2,this.fire=!1,this.gunX=n,this.gunY=r,this.isHit=!1,this.fillStyle="rgba(255,0,0, 0.5)",this.strokeStyle="rgb(255,0,0)",this.sightStyle="#FFFFFF",this.edgeWidth=1,this.sightSize=30,this.numOfFiredBullets=0};return r.prototype.addBullets=function(t,n){var r=e.makeBullets(t,n),i=this.bullets;r.forEach(function(e){i.push(e)})},r.prototype.start=function(){this.addBullets(t.BULLET.IRON_1,1e3)},r.prototype.update=function(e){this.x=e.mouseX,this.y=e.mouseY,this.fire=e.mouseDown,this.moveLeft=e.leftKey,this.moveRight=e.rightKey,this.moveLeft&&(this.gunX+=-10),this.moveRight&&(this.gunX+=10),this.angle=this.calAngleToTarget(this.gunX,this.gunY,this.x,this.y),this.fire&&this.numOfFiredBullets<this.bullets.length&&(this.bullets[this.numOfFiredBullets].update(this.gunX,this.gunY,this.angle),this.numOfFiredBullets+=1);for(var t=0;t<this.numOfFiredBullets;t++){var n=this.bullets[t];n.update()}},r.prototype.shoot=function(t){var n=t.weapons,r=0;return n.forEach(function(e){r+=this.shootWeapon(e)},this),t.removeDiedWeapons(),t.isShot=this.fire,r},r.prototype.shootWeapon=function(e){var r=0;if(e.shape===t.SHAPE_PLATE.ROUND)for(var i=0;i<this.numOfFiredBullets;i++){var s=this.bullets[i];if(s.isExploded)continue;var o=s.calAbsPosition();if(o.x<0)continue;var u=n.calDistance(o.x,o.y,e.x,e.y);u<this.sightSize&&(e.hit(),s.isExploded=!0,r++)}return r},r.prototype.renderSight=function(e){e.save(),e.translate(this.x,this.y),e.beginPath(),e.arc(0,0,this.sightSize,0,2*Math.PI),e.fillStyle=this.fillStyle,e.fill(),e.lineWidth=this.edgeWidth,e.strokeStyle=this.strokeStyle,e.stroke(),e.closePath(),e.restore()},r.prototype.renderTarget=function(e){e.save(),e.translate(this.x,this.y),e.beginPath(),e.moveTo(0,0-this.sightSize),e.lineTo(0,this.sightSize),e.moveTo(0-this.sightSize,0),e.lineTo(this.sightSize,0),e.closePath(),e.strokeStyle=this.sightStyle,e.stroke(),e.restore()},r.prototype.calAngleToTarget=n.calAngle,r.prototype.renderBody=function(e){e.save(),e.translate(this.gunX,this.gunY),e.rotate(this.angle),e.beginPath(),e.moveTo(0,0),e.lineTo(20,0),e.strokeStyle="#FFFFFF",e.lineWidth=this.sightSize/2,e.lineCap="round",e.stroke(),e.moveTo(20,0),e.lineTo(50,0),e.strokeStyle="#FFFFFF",e.lineWidth=this.sightSize/4,e.lineCap="round",e.stroke(),e.closePath(),e.restore()},r.prototype.renderBase=function(e){e.save(),e.translate(this.gunX,this.gunY),e.beginPath(),e.arc(0,0,this.sightSize,0,Math.PI,!0),e.fillStyle=this.fillStyle,e.fill(),e.strokeStyle=this.strokeStyle,e.lineWidth=this.sightSize/2,e.stroke(),e.closePath(),e.restore()},r.prototype.renderGun=function(e){this.renderBase(e),this.renderBody(e)},r.prototype.renderBullets=function(e){this.bullets.forEach(function(t){t.render(e)})},r.prototype.render=function(e){this.renderGun(e),this.renderSight(e),this.renderTarget(e),this.renderBullets(e)},r});